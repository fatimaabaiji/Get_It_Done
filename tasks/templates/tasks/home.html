{% extends 'tasks/base.html' %}

{% block content %}
<h1>Task List</h1>
<a href="{% url 'create_task' %}" class="btn btn-primary mb-3">Add Task</a>

{% if messages %}
    <div class="alert alert-success" role="alert">
        {% for message in messages %}
            {{ message }}
        {% endfor %}
    </div>
{% endif %}

<form method="get" action=".">
    <label for="sort_by">Sort by:</label>
    <select name="sort_by" id="sort_by">
        <option value="due_date">Due Date</option>
        <option value="priority">Priority</option>
        <option value="created_at">Creation Date</option>
    </select>
    <label for="status_filter">Filter by Status:</label>
    <select name="status_filter" id="status_filter">
        <option value="">All</option>
        <option value="not_started">Not Started</option>
        <option value="in_progress">In Progress</option>
        <option value="done">Completed</option>
    </select>
    <button type="submit">Apply</button>
</form>
<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead class="thead-dark">
            <tr>
                <th>Title</th>
                <th>Description</th>
                <th>Priority</th>
                <th>Status</th>
                <th>Due Date</th>
                <th>Created At</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for task in tasks %}
            <tr class="{% if task.priority == 'high' %}priority-high-row{% elif task.priority == 'medium' %}priority-medium-row{% else %}priority-low-row{% endif %}">
                <td><a href="{% url 'edit_task' task.id %}">{{ task.title }}</a></td>
                <td>{{ task.description }}</td>
                <td>
                    <button class="btn {% if task.priority == 'high' %}priority-high{% elif task.priority == 'medium' %}priority-medium{% else %}priority-low{% endif %}">
                        {{ task.priority|capfirst }}
                    </button>
                </td>
                <td>
                    <form method="post" action="{% url 'update_task' task.id %}" class="update-form">
                        {% csrf_token %}
                        <input type="hidden" name="priority" value="{{ task.priority }}">
                        <select name="status" class="form-control" onchange="submitForm(this)">
                            <option value="not_started" {% if task.status == 'not_started' %}selected{% endif %}>Not Started</option>
                            <option value="in_progress" {% if task.status == 'in_progress' %}selected{% endif %}>In Progress</option>
                            <option value="done" {% if task.status == 'done' %}selected{% endif %}>Done</option>
                        </select>
                    </form>
                </td>
                <td>
                    <input type="date" name="due_date" class="form-control" value="{{ task.due_date|date:'Y-m-d' }}">
                </td>
                <td>{{ task.created_at|time:"H:i" }}</td>
                <td>
                    <a href="{% url 'edit_task' task.id %}" class="btn btn-sm btn-warning">Edit</a>
                    <a href="{% url 'delete_task' task.id %}" class="btn btn-sm btn-danger">Delete</a>
                </td>
            </tr>
            {% endfor %}
            {% for task in guest_tasks %}
            <tr class="{% if task.priority == 'high' %}priority-high-row{% elif task.priority == 'medium' %}priority-medium-row{% else %}priority-low-row{% endif %}">
                <td><a href="{% url 'register' %}">{{ task.title }}</a></td>
                <td>{{ task.description }}</td>
                <td>
                    <button class="btn {% if task.priority == 'high' %}priority-high{% elif task.priority == 'medium' %}priority-medium{% else %}priority-low{% endif %}">
                        {{ task.priority|capfirst }}
                    </button>
                </td>
                <td>
                    <select name="status" class="form-control">
                        <option value="not_started" {% if task.status == 'not_started' %}selected{% endif %}>Not Started</option>
                        <option value="in_progress" {% if task.status == 'in_progress' %}selected{% endif %}>In Progress</option>
                        <option value="done" {% if task.status == 'done' %}selected{% endif %}>Done</option>
                    </select>
                </td>
                <td>
                    <input type="date" name="due_date" class="form-control" value="{{ task.due_date|date:'Y-m-d' }}">
                </td>
                <td>{{ task.created_at }}</td>
                <td>
                    <a href="{% url 'register' %}" class="btn btn-sm btn-primary">Register to Save</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}

<script>
function submitForm(selectElement) {
    var form = selectElement.closest('form');
    var formData = new FormData(form);

    fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        console.log('Success:', data);
    })
    .catch((error) => {
        console.error('Error:', error);
    });
}
</script>
